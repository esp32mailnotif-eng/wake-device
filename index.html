<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Device Auto Wake & Setup</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#ffffff">
  <link rel="manifest" href="manifest.webmanifest">

  <style>
    body { font-family: sans-serif; padding: 16px; line-height: 1.4; }
    h1 { margin-top: 0; }
    button { padding: 10px 16px; font-size: 16px; margin: 6px 6px 6px 0; }
    #log { margin-top: 14px; white-space: pre-line; border: 1px solid #ccc; padding: 10px; }
    #countdown { font-weight: bold; margin-top: 10px; }

    .modalBackdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 16px;
    }
    .modal {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      width: min(520px, 100%);
    }
    .modal h2 { margin-top: 0; }
    .muted { color: #555; font-size: 14px; }
    .actions { margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; }
    code { background: #f2f2f2; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>

<body>

<h1>Device Auto Wake & Setup</h1>

<p>
<b>User instructions:</b><br>
1) Press <b>Auto Wake</b> and wait for the device to appear.<br>
2) Press <b>Pair</b> and confirm Bluetooth pairing.<br>
3) The phone will retry automatically and wake the device (countdown shown).<br>
4) When prompted, connect to the device Wi-Fi AP.<br>
5) After connecting, return to Chrome using <b>Recent Apps</b>.<br>
6) The setup page will open automatically.
</p>

<button id="btnStart">Auto Wake</button>
<button id="btnPair" disabled>Pair</button>
<button id="btnStop">Stop</button>

<div id="countdown"></div>
<div id="log"></div>

<!-- Wi-Fi / AP modal -->
<div id="apBackdrop" class="modalBackdrop">
  <div class="modal">
    <h2>Connect to Device Wi-Fi</h2>

    <p>
      The device is awake.<br>
      Please open Wi-Fi settings and connect to the device Access Point.
    </p>

    <p class="muted">
      After connecting, return to Chrome using <b>Recent Apps</b>.<br>
      The setup page will open automatically.
    </p>

    <p class="muted">
      Device page: <code>http://192.168.4.1</code>
    </p>

    <p id="apStatus" style="font-weight:bold;"></p>

    <div class="actions">
      <button id="btnOpenWifi">Open Wi-Fi Settings</button>
      <button id="btnOpenManual">Open Device Page</button>
      <button id="btnCloseModal">Close</button>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const SERVICE_UUID = '12345678-1234-1234-1234-1234567890ab';
const CHAR_UUID    = 'abcd1234-1234-1234-1234-1234567890ab';

const AP_URL = 'http://192.168.4.1/';
const WAKE_COUNTDOWN_MS = 75_000;

/* ================= STATE ================= */
let device = null;
let running = false;
let retryTimer = null;
let countdownTimer = null;
let countdownEnd = 0;
let apPollTimer = null;

/* ================= UI ================= */
const logEl = document.getElementById('log');
const countdownEl = document.getElementById('countdown');
const btnStart = document.getElementById('btnStart');
const btnPair = document.getElementById('btnPair');
const btnStop = document.getElementById('btnStop');

const apBackdrop = document.getElementById('apBackdrop');
const apStatus = document.getElementById('apStatus');
const btnOpenWifi = document.getElementById('btnOpenWifi');
const btnOpenManual = document.getElementById('btnOpenManual');
const btnCloseModal = document.getElementById('btnCloseModal');

/* ================= HELPERS ================= */
function log(msg) {
  console.log(msg);
  logEl.textContent += msg + '\n';
}

function stopAll(reason) {
  running = false;
  clearTimeout(retryTimer);
  clearInterval(countdownTimer);
  clearInterval(apPollTimer);
  countdownEl.textContent = '';
  if (reason) log('Stopped: ' + reason);
}

/* ================= COUNTDOWN ================= */
function startCountdown(ms) {
  countdownEnd = Date.now() + ms;
  countdownTimer = setInterval(() => {
    const left = countdownEnd - Date.now();
    if (left <= 0) {
      countdownEl.textContent = 'Countdown complete';
      clearInterval(countdownTimer);
      return;
    }
    const s = Math.ceil(left / 1000);
    countdownEl.textContent = 'Waking device… ' + s + 's';
  }, 250);
}

/* ================= BLE ================= */
async function requestDevice() {
  log('Waiting for BLE device...');
  device = await navigator.bluetooth.requestDevice({
    acceptAllDevices: true,
    optionalServices: [SERVICE_UUID]
  });
  log('Device found: ' + (device.name || 'unnamed'));
  btnPair.disabled = false;
}

async function tryWake() {
  if (!running) return;

  try {
    log('Connecting BLE...');
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    const ch = await service.getCharacteristic(CHAR_UUID);

    await ch.writeValue(new Uint8Array([0x01]));
    log('Wake command sent (0x01)');
    server.disconnect();

    running = false;
    showApModal();

  } catch (e) {
    retryTimer = setTimeout(tryWake, 3000);
  }
}

/* ================= AP DETECTION ================= */
function showApModal() {
  apBackdrop.style.display = 'flex';
  apStatus.textContent = 'Waiting for device Wi-Fi connection…';
  startApPolling();
  openWifiSettings();
}

function startApPolling() {
  apPollTimer = setInterval(checkAp, 1500);
  checkAp();
}

async function checkAp() {
  try {
    await fetch(AP_URL, { mode: 'no-cors', cache: 'no-store' });
    apStatus.textContent = 'Device detected. Opening setup page…';
    clearInterval(apPollTimer);
    setTimeout(() => window.location.href = AP_URL, 500);
  } catch {}
}

/* ================= BUTTONS ================= */
btnStart.onclick = async () => {
  logEl.textContent = '';
  if (!window.isSecureContext || !navigator.bluetooth) {
    alert('Use HTTPS and Chrome on Android');
    return;
  }
  await requestDevice();
};

btnPair.onclick = () => {
  running = true;
  startCountdown(WAKE_COUNTDOWN_MS);
  tryWake();
};

btnStop.onclick = () => stopAll('User stopped');

btnOpenWifi.onclick = openWifiSettings;
btnOpenManual.onclick = () => window.location.href = AP_URL;
btnCloseModal.onclick = () => apBackdrop.style.display = 'none';

/* ================= ANDROID WIFI SETTINGS ================= */
function openWifiSettings() {
  window.location.href =
    'intent:#Intent;action=android.settings.WIFI_SETTINGS;end';
}

/* ================= VISIBILITY ================= */
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && apBackdrop.style.display === 'flex') {
    checkAp();
  }
});

/* ================= SERVICE WORKER ================= */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js');
}
</script>

</body>
</html>
