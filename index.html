<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 Wake Pro v2.9.3</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --bg: #0f172a; --accent: #3b82f6; --success: #10b981; --warn: #f59e0b; --danger: #ef4444; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: white; text-align: center; padding: 15px; min-height: 100vh; }
        .card { background: #1e293b; padding: 20px; border-radius: 16px; max-width: 400px; margin: auto; border: 1px solid #334155; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .btn { background: var(--accent); border: none; padding: 18px; border-radius: 12px; color: white; font-size: 1.1rem; width: 100%; margin: 10px 0; cursor: pointer; font-weight: 600; text-decoration: none; display: block; }
        .btn-searching { background: var(--warn) !important; animation: pulse 1.5s infinite; }
        .success-flash { background: var(--success) !important; }
        #status { font-size: 0.85rem; color: #94a3b8; margin: 15px 0; padding: 12px; border-radius: 8px; background: #0f172a; border: 1px solid #334155; min-height: 120px; }
        .timer-row { display: flex; justify-content: space-between; margin-top: 8px; padding-top: 8px; border-top: 1px solid #1e293b; }
        .timer-val { font-family: monospace; font-size: 1rem; color: var(--accent); font-weight: bold; }
        .flags-box { background: #020617; border: 1px solid var(--danger); border-radius: 8px; padding: 10px; margin-top: 20px; text-align: left; font-size: 0.8rem; }
        .flags-box code { color: var(--warn); display: block; margin: 5px 0; }
        .heartbeat { width: 10px; height: 10px; background: var(--accent); border-radius: 50%; display: inline-block; margin-right: 8px; }
        .blink { animation: blinker 0.8s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        @keyframes pulse { 50% { opacity: 0.7; } }
    </style>
</head>
<body>

    <div class="card">
        <h2>S3 Wake Pro <small style="color:var(--accent)">v2.9.3</small></h2>
        <div id="device-list"></div>
        <button class="btn" style="background:transparent; border:2px dashed #444;" onclick="pairNew()">+ Pair New Device</button>
        
        <div id="status">
            <div id="msg">Ready to Wake</div>
            <div class="timer-row"><span>Radio Link:</span><span id="radio-timer" class="timer-val">0.000s</span></div>
            <div class="timer-row"><span>Total Wait:</span><span id="total-timer" class="timer-val">0.000s</span></div>
            <div class="timer-row"><span>Last Success:</span><span id="attempt-info" class="timer-val">--</span></div>
        </div>

        <hr style="border: 0; border-top: 1px solid #334155; margin: 15px 0;">
        <a href="intent:#Intent;action=android.settings.WIFI_SETTINGS;end" class="btn" style="background:#475569; font-size:0.9rem;">üì∂ Android WiFi List</a>
        <a href="http://192.168.4.1" target="_blank" class="btn" style="background:#6366f1;">üåê Open ESP32 Page</a>
        
        <div id="cancel-zone"></div>
        <div class="flags-box">
            <strong style="color: var(--danger)">REQUIRED CHROME FLAGS:</strong>
            <code>1. chrome://flags/#enable-experimental-web-platform-features</code>
            <code>2. chrome://flags/#enable-web-bluetooth-new-permissions-backend</code>
        </div>
    </div>

    <script>
        const S_UUID = "12345678-1234-1234-1234-1234567890ab";
        const C_UUID = "abcd1234-1234-1234-1234-1234567890ab";
        let isHunting = false;
        let globalStartTime, spikeStartTime;

        window.onload = async () => {
            try {
                const devices = await navigator.bluetooth.getDevices();
                const list = document.getElementById('device-list');
                list.innerHTML = "";
                devices.forEach(dev => {
                    const b = document.createElement('button');
                    b.className = "btn";
                    b.innerText = "Wake " + (dev.name || "ESP32");
                    b.onclick = () => { globalStartTime = performance.now(); startHunt(dev, b); };
                    list.appendChild(b);
                });
                document.getElementById('msg').innerText = "Memory Loaded. Ready.";
            } catch (e) { document.getElementById('msg').innerText = "‚ö†Ô∏è Flag Error!"; }
        };

        async function startHunt(device, btn) {
            if(isHunting) return;
            isHunting = true;
            btn.classList.add('btn-searching');
            document.getElementById('cancel-zone').innerHTML = `<button class="btn" style="background:var(--danger)" onclick="location.reload()">STOP</button>`;
            
            try {
                await device.watchAdvertisements();
                device.addEventListener('advertisementreceived', async (event) => {
                    spikeStartTime = performance.now();
                    
                    for(let i=1; i<=5; i++) {
                        document.getElementById('msg').innerHTML = `<span class="heartbeat blink"></span>Attempt #${i}...`;
                        try {
                            const server = await device.gatt.connect();
                            const service = await server.getPrimaryService(S_UUID);
                            const char = await service.getCharacteristic(C_UUID);
                            await char.writeValue(new Uint8Array([0x01]));

                            const now = performance.now();
                            document.getElementById('radio-timer').innerText = ((now - spikeStartTime) / 1000).toFixed(3) + "s";
                            document.getElementById('total-timer').innerText = ((now - globalStartTime) / 1000).toFixed(3) + "s";
                            document.getElementById('attempt-info').innerText = "Try #" + i;
                            document.getElementById('msg').innerHTML = "<span style='color:var(--success)'>‚úÖ DELIVERED</span>";
                            
                            isHunting = false;
                            btn.classList.replace('btn-searching', 'success-flash');
                            if ("vibrate" in navigator) navigator.vibrate([200, 100, 200]);
                            setTimeout(() => location.reload(), 10000);
                            return;
                        } catch (err) {
                            await new Promise(r => setTimeout(r, 30));
                        }
                    }
                });
            } catch (e) { }
        }

        async function pairNew() {
            try { await navigator.bluetooth.requestDevice({ filters: [{ services: [S_UUID] }] }); location.reload(); } catch (e) { }
        }
    </script>
</body>
</html>
