<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 Wake Pro v2.3</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --bg: #0f172a; --accent: #3b82f6; --success: #10b981; --warn: #f59e0b; --danger: #ef4444; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: white; text-align: center; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; }
        .card { background: #1e293b; padding: 20px; border-radius: 16px; max-width: 400px; margin: auto; border: 1px solid #334155; flex-grow: 1; }
        .btn { background: var(--accent); border: none; padding: 18px; border-radius: 12px; color: white; font-size: 1.1rem; width: 100%; margin: 10px 0; cursor: pointer; transition: 0.3s; font-weight: 600; }
        .btn-searching { background: var(--warn) !important; animation: pulse 1.5s infinite; }
        .btn-cancel { background: var(--danger); margin-top: 20px; font-size: 0.9rem; }
        .success-flash { background: var(--success) !important; transform: scale(1.05); }
        #status { font-size: 0.9rem; color: #94a3b8; margin: 20px 0; padding: 15px; border-radius: 8px; background: #0f172a; min-height: 50px; border: 1px solid #334155; line-height: 1.4; }
        footer { margin-top: 30px; font-size: 0.75rem; color: #475569; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="card">
        <h2>S3 Wake Pro <small style="color:var(--accent)">v2.3</small></h2>
        
        <div id="device-list"></div>
        <button class="btn" style="background:transparent; border:2px dashed #444;" onclick="pairNew()">+ Pair New Device</button>
        
        <div id="status">Ready to scan...</div>

        <div id="cancel-zone"></div>

        <footer>
            <strong>Service Discovery Mode</strong><br>
            Requires <code>#experimental-web-platform-features</code>
        </footer>
    </div>

    <script>
        const S_UUID = "12345678-1234-1234-1234-1234567890ab";
        const C_UUID = "abcd1234-1234-1234-1234-1234567890ab";
        let isHunting = false;

        window.onload = refreshList;

        async function refreshList() {
            if (!navigator.bluetooth.getDevices) {
                updateStatus("âš ï¸ PERSISTENCE ERROR: Enable chrome://flags");
                return;
            }
            const devices = await navigator.bluetooth.getDevices();
            const list = document.getElementById('device-list');
            list.innerHTML = "";
            
            devices.forEach(dev => {
                const b = document.createElement('button');
                b.className = "btn";
                b.innerText = "Wake " + (dev.name || "ESP32");
                b.onclick = () => startHunt(dev, b);
                list.appendChild(b);
            });
            updateStatus(devices.length > 0 ? "Saved device found. Tap to begin hunting." : "No saved devices.");
        }

        async function startHunt(device, btn) {
            if(isHunting) return;
            isHunting = true;
            btn.classList.add('btn-searching');
            const originalText = btn.innerText;

            // Show Cancel Button
            const cz = document.getElementById('cancel-zone');
            cz.innerHTML = `<button class="btn btn-cancel" onclick="location.reload()">STOP SEARCHING</button>`;

            while (isHunting) {
                updateStatus("ðŸ“¡ Hunting...<br>Waiting for ESP32 600ms Spike");
                btn.innerText = "SEARCHING...";
                
                try {
                    // Step 1: Physical Connection
                    const server = await device.gatt.connect();
                    updateStatus("ðŸ”— Found! Discovering Services...");

                    // Step 2: Fresh Service Discovery (Fixes the Deep Sleep cache issue)
                    const service = await server.getPrimaryService(S_UUID);
                    const char = await service.getCharacteristic(C_UUID);
                    
                    // Step 3: Write Command
                    await char.writeValue(new Uint8Array([0x01]));
                    
                    // SUCCESS FEEDBACK
                    isHunting = false; 
                    if ("vibrate" in navigator) navigator.vibrate([200, 100, 200]);
                    
                    updateStatus("âœ… SUCCESS!<br>0x01 Sent & Acknowledged");
                    btn.classList.remove('btn-searching');
                    btn.classList.add('success-flash');
                    btn.innerText = "SIGNAL SENT!";
                    
                    setTimeout(() => {
                        device.gatt.disconnect();
                        location.reload(); 
                    }, 4000);

                } catch (e) {
                    // Logic for Sleep: Wait 1 second and retry
                    console.log("Retry Loop:", e.message);
                    updateStatus("S3 Sleeping...<br>Retrying every 1s");
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
        }

        async function pairNew() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [S_UUID] }]
                });
                refreshList();
            } catch (e) { updateStatus("Pairing cancelled."); }
        }

        function updateStatus(msg) { document.getElementById('status').innerHTML = msg; }
    </script>
</body>
</html>
